"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[414],{60414:function(e,t,r){var i,s,a,n,o,l=r(21876).Buffer,d=r(83454),c=Object.defineProperty,p=Object.getOwnPropertyDescriptor,u=Object.getOwnPropertyNames,g=Object.prototype.hasOwnProperty,h={};((e,t)=>{for(var r in t)c(e,r,{get:t[r],enumerable:!0})})(h,{TransformersJSEmbeddingModel:()=>R,TransformersJSLanguageModel:()=>j,TransformersJSTranscriptionModel:()=>B,TransformersJSTranscriptionWorkerHandler:()=>es,TransformersJSWorkerHandler:()=>et,createTransformersJS:()=>H,doesBrowserSupportTransformersJS:()=>U,isBrowserEnvironment:()=>F,isServerEnvironment:()=>J,transformersJS:()=>Q}),e.exports=((e,t,r,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of u(t))g.call(e,r)||void 0===r||c(e,r,{get:()=>t[r],enumerable:!(i=p(t,r))||i.enumerable});return e})(c({},"__esModule",{value:!0}),h);var f="vercel.ai.error",m=Symbol.for(f),y=class e extends Error{constructor({name:e,message:t,cause:r}){super(t),this[i]=!0,this.name=e,this.cause=r}static isInstance(t){return e.hasMarker(t,f)}static hasMarker(e,t){let r=Symbol.for(t);return null!=e&&"object"==typeof e&&r in e&&"boolean"==typeof e[r]&&!0===e[r]}};i=m;var w=y,k=(Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError"),Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError"),Symbol.for("vercel.ai.error.AI_JSONParseError"),Symbol.for("vercel.ai.error.AI_LoadAPIKeyError"),"AI_LoadSettingError"),v=`vercel.ai.error.${k}`,_=Symbol.for(v),b=class extends w{constructor({message:e}){super({name:k,message:e}),this[s]=!0}static isInstance(e){return w.hasMarker(e,v)}};s=_,Symbol.for("vercel.ai.error.AI_NoContentGeneratedError");var M="AI_NoSuchModelError",S=`vercel.ai.error.${M}`,I=Symbol.for(S),A=class extends w{constructor({errorName:e=M,modelId:t,modelType:r,message:i=`No such ${r}: ${t}`}){super({name:e,message:i}),this[a]=!0,this.modelId=t,this.modelType=r}static isInstance(e){return w.hasMarker(e,S)}};a=I;var E="AI_TooManyEmbeddingValuesForCallError",T=`vercel.ai.error.${E}`,x=Symbol.for(T),P=class extends w{constructor(e){super({name:E,message:`Too many values for a single embedding call. The ${e.provider} model "${e.modelId}" can only embed up to ${e.maxEmbeddingsPerCall} values per call, but ${e.values.length} values were provided.`}),this[n]=!0,this.provider=e.provider,this.modelId=e.modelId,this.maxEmbeddingsPerCall=e.maxEmbeddingsPerCall,this.values=e.values}static isInstance(e){return w.hasMarker(e,T)}};n=x,Symbol.for("vercel.ai.error.AI_TypeValidationError");var z="AI_UnsupportedFunctionalityError",C=`vercel.ai.error.${z}`,$=Symbol.for(C),L=class extends w{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:z,message:t}),this[o]=!0,this.functionality=e}static isInstance(e){return w.hasMarker(e,C)}};o=$;var W=r(98529);function q(e){return btoa(String.fromCharCode(...e))}function F(){return"undefined"!=typeof window}function J(){return"undefined"==typeof window&&void 0!==d}function U(){return!!F()&&("undefined"!=typeof navigator&&!!navigator.gpu||"undefined"!=typeof WebAssembly)}var V=class extends W.StoppingCriteria{constructor(){super(...arguments),this.interrupted=!1}interrupt(){this.interrupted=!0}reset(){this.interrupted=!1}_call(e,t){return Array(e.length).fill(this.interrupted)}},N=class extends W.TextStreamer{constructor(e,t){super(e,{skip_prompt:!0,skip_special_tokens:!0}),this.cb=t}on_finalized_text(e){this.cb(e)}},j=class{constructor(e,t={}){this.specificationVersion="v2",this.provider="transformers-js",this.isInitialized=!1,this.stoppingCriteria=new V,this.workerReady=!1,this.supportedUrls={},this.modelId=e,this.config={modelId:e,device:"auto",dtype:"auto",isVisionModel:!1,...t}}async getSession(e){if(this.modelInstance&&this.isInitialized||this.initializationPromise&&(await this.initializationPromise,this.modelInstance))return this.modelInstance;if(this.initializationPromise=this._initializeModel(e),await this.initializationPromise,!this.modelInstance)throw new b({message:"Model initialization failed"});return this.modelInstance}async _initializeModel(e){try{let{isVisionModel:t,device:r,dtype:i}=this.config,s=this.createProgressTracker(e),a=this.resolveDevice(r),n=this.resolveDtype(i);if(t){let[e,t]=await Promise.all([W.AutoProcessor.from_pretrained(this.modelId,{progress_callback:s}),W.AutoModelForVision2Seq.from_pretrained(this.modelId,{dtype:n,device:a,progress_callback:s})]);this.modelInstance=[e,t]}else{let[e,t]=await Promise.all([W.AutoTokenizer.from_pretrained(this.modelId,{legacy:!0,progress_callback:s}),W.AutoModelForCausalLM.from_pretrained(this.modelId,{dtype:n,device:a,progress_callback:s})]);if(this.modelInstance=[e,t],F()){let r=e("Hello");await t.generate({...r,max_new_tokens:1})}}e?.({progress:1}),this.isInitialized=!0}catch(e){throw this.modelInstance=void 0,this.isInitialized=!1,this.initializationPromise=void 0,new b({message:`Failed to initialize TransformersJS model: ${e instanceof Error?e.message:"Unknown error"}`})}}resolveDevice(e){return e&&"auto"!==e?e:J()?"cpu":F()&&"undefined"!=typeof navigator&&navigator.gpu?"webgpu":"cpu"}resolveDtype(e){return e&&"auto"!==e?e:"auto"}createProgressTracker(e){let t=new Map;return r=>{if(this.config.rawInitProgressCallback?.(r),!e)return;let i=r.file;if(!i)return;if("progress"===r.status&&i)t.set(i,{loaded:r.loaded||0,total:r.total||0});else if("done"===r.status&&i){let e=t.get(i);e?.total&&t.set(i,{loaded:e.total,total:e.total})}let s=0,a=0;for(let{loaded:e,total:r}of t.values())r>0&&(s+=e,a+=r);a>0&&e({progress:Math.min(1,s/a)})}}getArgs({prompt:e,maxOutputTokens:t,temperature:r,topP:i,topK:s,frequencyPenalty:a,presencePenalty:n,stopSequences:o,responseFormat:d,seed:c,tools:p}){let u=[];return p&&p.length>0&&u.push({type:"unsupported-setting",setting:"tools",details:"Tool calling is not yet supported by TransformersJS"}),null!=a&&u.push({type:"unsupported-setting",setting:"frequencyPenalty",details:"Frequency penalty is not supported by TransformersJS"}),null!=n&&u.push({type:"unsupported-setting",setting:"presencePenalty",details:"Presence penalty is not supported by TransformersJS"}),null!=o&&u.push({type:"unsupported-setting",setting:"stopSequences",details:"Stop sequences are not supported by TransformersJS"}),d?.type==="json"&&u.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format is not supported by TransformersJS"}),null!=c&&u.push({type:"unsupported-setting",setting:"seed",details:"Seed is not supported by TransformersJS"}),{messages:function(e,t=!1){return e.map(e=>{switch(e.role){case"system":return{role:"system",content:e.content};case"user":if(t)return{role:"user",content:function(e){let t=[],r=[];for(let i of e)if("text"===i.type)r.push(i.text);else if("file"===i.type&&i.mediaType?.startsWith("image/"))r.length>0&&(t.push({type:"text",text:r.join("\n")}),r=[]),t.push({type:"image",image:function(e,t){if(e instanceof URL)return e.toString();if("string"==typeof e)return`data:${t};base64,${e}`;if(e instanceof Uint8Array)return`data:${t};base64,${q(e)}`;if(e instanceof ArrayBuffer)return`data:${t};base64,${q(new Uint8Array(e))}`;if(void 0!==l&&e instanceof l)return`data:${t};base64,${e.toString("base64")}`;throw new L({functionality:`file data type: ${typeof e}`})}(i.data,i.mediaType)});else if("file"===i.type)throw new L({functionality:"non-image file input"});return r.length>0&&t.push({type:"text",text:r.join("\n")}),t}(e.content)};return{role:"user",content:e.content.map(e=>{if("text"===e.type)return e.text;if("file"===e.type)throw new L({functionality:"file input"});return""}).join("\n")};case"assistant":return{role:"assistant",content:e.content.map(e=>{if("text"===e.type)return e.text;if("tool-call"===e.type)throw new L({functionality:"tool calling"});return""}).join("")};case"tool":throw new L({functionality:"tool results"});default:throw Error(`Unsupported message role: ${e.role}`)}})}(e,this.config.isVisionModel),warnings:u,generationOptions:{max_new_tokens:t||32768,temperature:r||.7,top_p:i,top_k:s,do_sample:void 0!==r&&r>0}}}async availability(){return this.config.worker&&F()?this.workerReady?"available":"downloadable":(J()&&this.config.worker,this.isInitialized)?"available":"downloadable"}async createSessionWithProgress(e){return this.config.worker&&F()?await this.initializeWorker(e):await this._initializeModel(e),this}async doGenerate(e){let{messages:t,warnings:r,generationOptions:i}=this.getArgs(e);if(this.config.worker&&F())return this.doGenerateWithWorker(t,r,i,e);let[s,a]=await this.getSession(this.config.initProgressCallback);try{let e,n;let o=this.config.isVisionModel,l=0;if(o){let r=s.apply_chat_template(t,{add_generation_prompt:!0}),o=t.flatMap(e=>Array.isArray(e.content)?e.content:[]).filter(e=>"image"===e.type).map(e=>e.image);e=await s(r,o.length>0?o:void 0);let l=await a.generate({...e,...i});n=s.batch_decode(l,{skip_special_tokens:!0})[0]}else{e=s.apply_chat_template(t,{add_generation_prompt:!0,return_dict:!0});let r=await a.generate({...e,...i});l=e.input_ids.data.length;let o=r.sequences||r,d=Array.isArray(o)?o[0]:o;(n=function(e,t,r){let i=t.data||t,s=Array.isArray(i)?i:Array.from(i),a=s.length>r?s.slice(r):s;return a.length>0?e.decode(a,{skip_special_tokens:!0}):""}(s,d,l)).split("")}return{content:[{type:"text",text:n}],finishReason:"stop",usage:o?{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0}:{inputTokens:l,outputTokens:n.length,totalTokens:l+n.length},request:{body:{messages:t,...i}},warnings:r}}catch(e){throw Error(`TransformersJS generation failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async doGenerateWithWorker(e,t,r,i){let s=this.config.worker;return await this.initializeWorker(),{content:[{type:"text",text:await new Promise((t,a)=>{let n=e=>{let r=e.data;r&&("complete"===r.status&&Array.isArray(r.output)?(s.removeEventListener("message",n),t(String(r.output[0]??""))):"error"===r.status&&(s.removeEventListener("message",n),a(Error(String(r.data||"Worker error")))))};if(s.addEventListener("message",n),s.postMessage({type:"generate",data:e,generationOptions:r}),i.abortSignal){let e=()=>{s.postMessage({type:"interrupt"}),i.abortSignal?.removeEventListener("abort",e)};i.abortSignal.addEventListener("abort",e)}})}],finishReason:"stop",usage:{inputTokens:void 0,outputTokens:void 0,totalTokens:void 0},request:{body:{messages:e,...r}},warnings:t}}async initializeWorker(e){if(!this.config.worker)return;if(this.workerReady){e&&e({progress:1});return}let t=this.config.worker;await new Promise((r,i)=>{let s=this.createProgressTracker(e),a=n=>{let o=n.data;if(o&&o&&"object"==typeof o&&"status"in o){if("ready"===o.status){t.removeEventListener("message",a),this.workerReady=!0,e&&e({progress:1}),r();return}if("error"===o.status){t.removeEventListener("message",a),i(Error(String(o.data||"Worker initialization failed")));return}o.file&&s(o)}};t.addEventListener("message",a),t.postMessage({type:"load",data:{modelId:this.modelId,dtype:this.config.dtype,device:this.config.device,isVisionModel:this.config.isVisionModel}})})}async doStream(e){let{messages:t,warnings:r,generationOptions:i}=this.getArgs(e);if(this.config.worker&&F())return this.doStreamWithWorker(t,r,i,e);let s=this;return{stream:new ReadableStream({async start(a){let n=!0,o="text-0";a.enqueue({type:"stream-start",warnings:r});try{let[r,l]=await s.getSession(s.config.initProgressCallback),d=r.apply_chat_template(t,{add_generation_prompt:!0,return_dict:!0}),c=d.input_ids.data.length,p=0,u=new N(r,e=>{n&&(a.enqueue({type:"text-start",id:o}),n=!1),p++,a.enqueue({type:"text-delta",id:o,delta:e})});s.stoppingCriteria.reset(),e.abortSignal&&e.abortSignal.addEventListener("abort",()=>{s.stoppingCriteria.interrupt()});let g=new W.StoppingCriteriaList;g.extend([s.stoppingCriteria]),await l.generate({...d,...i,streamer:u,stopping_criteria:g}),n||a.enqueue({type:"text-end",id:o}),a.enqueue({type:"finish",finishReason:"stop",usage:{inputTokens:c,outputTokens:p,totalTokens:c+p}})}catch(e){a.error(e)}finally{a.close()}}}),request:{body:{messages:t,...i}}}}async doStreamWithWorker(e,t,r,i){let s=this.config.worker;return await this.initializeWorker(),{stream:new ReadableStream({start:a=>{let n=!0,o="text-0";a.enqueue({type:"stream-start",warnings:t});let l=e=>{let t=e.data;t&&("start"===t.status||("update"===t.status&&"string"==typeof t.output?(n&&(a.enqueue({type:"text-start",id:o}),n=!1),a.enqueue({type:"text-delta",id:o,delta:t.output})):"complete"===t.status?(n||a.enqueue({type:"text-end",id:o}),a.enqueue({type:"finish",finishReason:"stop",usage:{inputTokens:void 0,outputTokens:t.numTokens,totalTokens:void 0}}),s.removeEventListener("message",l),a.close()):"error"===t.status&&(s.removeEventListener("message",l),a.error(Error(String(t.data||"Worker error"))))))};if(s.addEventListener("message",l),i.abortSignal){let e=()=>{s.postMessage({type:"interrupt"}),i.abortSignal?.removeEventListener("abort",e)};i.abortSignal.addEventListener("abort",e)}s.postMessage({type:"generate",data:e,generationOptions:r})}}),request:{body:{messages:e,...r}}}}},D=r(98529),R=class{constructor(e,t={}){this.specificationVersion="v2",this.provider="transformers-js",this.maxEmbeddingsPerCall=100,this.supportsParallelCalls=!1,this.pipeline=null,this.tokenizer=null,this.isInitialized=!1,this.modelId=e,this.config={modelId:e,device:"auto",dtype:"auto",normalize:!0,pooling:"mean",maxTokens:512,...t}}async getSession(e){if(this.pipeline&&this.tokenizer&&this.isInitialized||this.initializationPromise&&(await this.initializationPromise,this.pipeline&&this.tokenizer))return[this.tokenizer,this.pipeline];if(this.initializationPromise=this._initializeModel(e),await this.initializationPromise,!this.pipeline||!this.tokenizer)throw new b({message:"Embedding model initialization failed"});return[this.tokenizer,this.pipeline]}async _initializeModel(e){try{let{device:t,dtype:r}=this.config,i=this.createProgressTracker(e),s=this.resolveDevice(t),a=this.resolveDtype(r),[n,o]=await Promise.all([D.AutoTokenizer.from_pretrained(this.modelId,{legacy:!0,progress_callback:i}),(0,D.pipeline)("feature-extraction",this.modelId,{device:s,dtype:a,progress_callback:i})]);this.tokenizer=n,this.pipeline=o,e?.({progress:1}),this.isInitialized=!0}catch(e){throw this.pipeline=null,this.tokenizer=null,this.isInitialized=!1,this.initializationPromise=void 0,new b({message:`Failed to initialize TransformersJS embedding model: ${e instanceof Error?e.message:"Unknown error"}`})}}resolveDevice(e){return e&&"auto"!==e?e:"undefined"==typeof window&&void 0!==d?"cpu":"undefined"!=typeof window&&"undefined"!=typeof navigator&&navigator.gpu?"webgpu":"cpu"}resolveDtype(e){return e&&"auto"!==e?e:"q8"}createProgressTracker(e){let t=new Map;return r=>{if(this.config.rawInitProgressCallback?.(r),!e)return;let i=r.file;if(!i)return;if("progress"===r.status&&i)t.set(i,{loaded:r.loaded||0,total:r.total||0});else if("done"===r.status&&i){let e=t.get(i);e?.total&&t.set(i,{loaded:e.total,total:e.total})}let s=0,a=0;for(let{loaded:e,total:r}of t.values())r>0&&(s+=e,a+=r);a>0&&e({progress:Math.min(1,s/a)})}}applyPooling(e,t){if("cls"===t)return e[0];let r=e[0].length;if("max"===t){let t=Array(r).fill(-1/0);for(let i of e)for(let e=0;e<r;e++)t[e]=Math.max(t[e],i[e]);return t}let i=Array(r).fill(0);for(let t of e)for(let e=0;e<r;e++)i[e]+=t[e];return i.map(t=>t/e.length)}normalizeVector(e){let t=Math.sqrt(e.reduce((e,t)=>e+t*t,0));return t>0?e.map(e=>e/t):e}async availability(){return this.isInitialized?"available":"downloadable"}async createSessionWithProgress(e){return await this._initializeModel(e),this}async doEmbed(e){let{values:t}=e;if(t.length>this.maxEmbeddingsPerCall)throw new P({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:t});let[r,i]=await this.getSession(this.config.initProgressCallback),s=await Promise.all(t.map(async e=>{try{let t;let s=await r(e,{padding:!0,truncation:!0,max_length:this.config.maxTokens,return_tensors:!1}),a=await i(e,{pooling:"none",normalize:!1});if(a&&"object"==typeof a&&"data"in a&&"dims"in a){let e=Array.from(a.data),r=a.dims;if(3===r.length){let[i,s,a]=r,n=[];for(let t=0;t<s;t++){let r=[];for(let i=0;i<a;i++)r.push(e[t*a+i]);n.push(r)}t=this.applyPooling(n,this.config.pooling||"mean")}else if(2===r.length){let[i,s]=r,a=[];for(let t=0;t<i;t++){let r=[];for(let i=0;i<s;i++)r.push(e[t*s+i]);a.push(r)}t=this.applyPooling(a,this.config.pooling||"mean")}else if(1===r.length)t=e;else throw Error(`Unsupported tensor dimensions: ${r}`)}else if(Array.isArray(a)&&Array.isArray(a[0])&&Array.isArray(a[0][0]))t=this.applyPooling(a[0],this.config.pooling||"mean");else if(Array.isArray(a)&&"number"==typeof a[0])t=a;else throw console.error("Unexpected result format:",a),Error("Unexpected embedding result format");return this.config.normalize&&(t=this.normalizeVector(t)),{embedding:t,tokenCount:Array.isArray(s.input_ids)?s.input_ids.length:0}}catch(e){throw Error(`Failed to generate embedding for text: ${e}`)}})),a=s.reduce((e,{tokenCount:t})=>e+t,0);return{embeddings:s.map(({embedding:e})=>e),usage:{tokens:a}}}},O=r(98529);function G(){return"undefined"!=typeof window}function K(){return"undefined"==typeof window&&void 0!==d}var B=class{constructor(e,t={}){this.specificationVersion="v2",this.provider="transformers-js",this.isInitialized=!1,this.workerReady=!1,this.modelId=e,this.config={modelId:e,device:"auto",dtype:"auto",maxNewTokens:64,returnTimestamps:!1,...t}}async getSession(e){if(this.modelInstance&&this.isInitialized||this.initializationPromise&&(await this.initializationPromise,this.modelInstance))return this.modelInstance;if(this.initializationPromise=this._initializeModel(e),await this.initializationPromise,!this.modelInstance)throw new b({message:"Transcription model initialization failed"});return this.modelInstance}async _initializeModel(e){try{let{device:t,dtype:r}=this.config,i=this.createProgressTracker(e),s=this.resolveDevice(t),a=this.resolveDtype(r),[n,o,l]=await Promise.all([O.AutoTokenizer.from_pretrained(this.modelId,{progress_callback:i}),O.AutoProcessor.from_pretrained(this.modelId,{progress_callback:i}),O.WhisperForConditionalGeneration.from_pretrained(this.modelId,{dtype:a,device:s,progress_callback:i})]);if(this.modelInstance=[n,o,l],G())try{await l.generate({inputs:(0,O.full)([1,80,3e3],0)})}catch(e){console.warn("Model warmup failed:",e)}e?.({progress:1}),this.isInitialized=!0}catch(e){throw this.modelInstance=void 0,this.isInitialized=!1,this.initializationPromise=void 0,new b({message:`Failed to initialize TransformersJS transcription model: ${e instanceof Error?e.message:"Unknown error"}`})}}resolveDevice(e){return e&&"auto"!==e?e:K()?"cpu":"auto"}resolveDtype(e){return e&&"auto"!==e?e:{encoder_model:"auto",decoder_model_merged:"auto"}}createProgressTracker(e){let t=new Map;return r=>{if(this.config.rawInitProgressCallback?.(r),!e)return;let i=r.file;if(!i)return;if("progress"===r.status&&i)t.set(i,{loaded:r.loaded||0,total:r.total||0});else if("done"===r.status&&i){let e=t.get(i);e?.total&&t.set(i,{loaded:e.total,total:e.total})}let s=0,a=0;for(let{loaded:e,total:r}of t.values())r>0&&(s+=e,a+=r);a>0&&e({progress:Math.min(1,s/a)})}}convertAudioToFloat32Array(e){return new Promise((t,r)=>{try{let i;if("string"==typeof e){let t=atob(e);i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e)}else if(e instanceof Uint8Array)i=e;else if(e instanceof ArrayBuffer)i=new Uint8Array(e);else throw Error("Unsupported audio format");if("undefined"!=typeof AudioContext||void 0!==window?.webkitAudioContext)new(AudioContext||window.webkitAudioContext)({sampleRate:16e3}).decodeAudioData(i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)).then(e=>{let r=e.getChannelData(0);t(new Float32Array(r))}).catch(r);else{let e=new Float32Array(i.length);for(let t=0;t<i.length;t++)e[t]=(i[t]-128)/128;t(e)}}catch(e){r(e)}})}getArgs({audio:e,providerOptions:t}){let r=t?.["transformers-js"];return{audio:e,language:"string"==typeof r?.language?r.language:this.config.language,returnTimestamps:"boolean"==typeof r?.returnTimestamps?r.returnTimestamps:this.config.returnTimestamps,maxNewTokens:"number"==typeof r?.maxNewTokens?r.maxNewTokens:this.config.maxNewTokens,warnings:[]}}async availability(){return this.config.worker&&G()?this.workerReady?"available":"downloadable":(K()&&this.config.worker,this.isInitialized)?"available":"downloadable"}async createSessionWithProgress(e){return this.config.worker&&G()?await this.initializeWorker(e):(this.initializationPromise||(this.initializationPromise=this._initializeModel(e)),await this.initializationPromise),this}async doGenerate(e){let t=new Date,{audio:r,language:i,returnTimestamps:s,maxNewTokens:a,warnings:n}=this.getArgs(e);if(this.config.worker&&G())return this.doGenerateWithWorker(r,i,s,a,n,t,e);let[o,l,d]=await this.getSession(this.config.initProgressCallback);try{let e=await this.convertAudioToFloat32Array(r),c=e.length/16e3,p=await l(e),u=await d.generate({...p,max_new_tokens:a,language:i,return_timestamps:s}),g=o.batch_decode(u,{skip_special_tokens:!0})[0];return{text:g,segments:[],language:"string"==typeof i?i:void 0,durationInSeconds:c,warnings:n,response:{timestamp:t,modelId:this.modelId,headers:{},body:JSON.stringify({text:g})}}}catch(e){throw Error(`TransformersJS transcription failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async doGenerateWithWorker(e,t,r,i,s,a,n){let o=this.config.worker;await this.initializeWorker();let l=await this.convertAudioToFloat32Array(e),d=l.length/16e3,c=await new Promise((e,r)=>{let s=t=>{let i=t.data;i&&("complete"===i.status&&Array.isArray(i.output)?(o.removeEventListener("message",s),e(String(i.output[0]??""))):"error"===i.status&&(o.removeEventListener("message",s),r(Error(String(i.data||"Worker error")))))};if(o.addEventListener("message",s),o.postMessage({type:"generate",data:{audio:Array.from(l),language:t,maxNewTokens:i}}),n.abortSignal){let e=()=>{o.postMessage({type:"interrupt"}),n.abortSignal?.removeEventListener("abort",e)};n.abortSignal.addEventListener("abort",e)}});return{text:c,segments:[],language:"string"==typeof t?t:void 0,durationInSeconds:d,warnings:s,response:{timestamp:a,modelId:this.modelId,headers:{},body:JSON.stringify({text:c})}}}async initializeWorker(e){if(!this.config.worker)return;if(this.workerReady){e&&e({progress:1});return}let t=this.config.worker;await new Promise((r,i)=>{let s=this.createProgressTracker(e),a=n=>{let o=n.data;if(o){if(o&&"object"==typeof o&&"status"in o){if("ready"===o.status){t.removeEventListener("message",a),this.workerReady=!0,e&&e({progress:1}),r();return}if("error"===o.status){t.removeEventListener("message",a),i(Error(String(o.data||"Worker initialization failed")));return}}o.file&&s(o)}};t.addEventListener("message",a),t.postMessage({type:"load",data:{modelId:this.modelId,dtype:this.config.dtype,device:this.config.device,maxNewTokens:this.config.maxNewTokens}})})}};function H(e={}){let t=(e,t)=>{if(J()){let{worker:r,...i}=t||{},s=function(e,t){let r=(t?.device??"auto").toString(),i=(t?.dtype??"auto").toString(),s=!!t?.isVisionModel;return`${e}::${r}::${i}::${s?"vision":"text"}`}(e,i),a=X.get(s);if(a)return a;let n=new j(e,i);return X.set(s,n),n}return new j(e,t)},r=(e,t)=>new R(e,t),i=(e,t)=>{if(J()){let r=function(e,t){let r=(t?.device??"auto").toString(),i=(t?.dtype??"auto").toString(),s=(t?.maxNewTokens??64).toString();return`${e}::${r}::${i}::${s}`}(e,t),i=Y.get(r);if(i)return i;let s=new B(e,t);return Y.set(r,s),s}return new B(e,t)},s=function(e,r){if(new.target)throw Error("The TransformersJS model function cannot be called with the new keyword.");return t(e,r)};return s.languageModel=t,s.chat=t,s.textEmbedding=r,s.textEmbeddingModel=r,s.transcription=i,s.transcriptionModel=i,s.imageModel=e=>{throw new A({modelId:e,modelType:"imageModel"})},s.speechModel=e=>{throw new A({modelId:e,modelType:"speechModel"})},s}var Q=H(),X=new Map,Y=new Map,Z=r(98529),ee=class{static configure(e,t){this.configs.set(e,t)}static async getInstance(e,t){let r=this.instances.get(e);if(r)return r;let i=this.configs.get(e);if(!i||!i.modelId)throw Error(`No configuration found for key: ${e}`);let{modelId:s,dtype:a="auto",device:n="auto",use_external_data_format:o=!1,isVisionModel:l=!1}=i,d=l?this.createVisionModel(s,{dtype:a,device:n,use_external_data_format:o,progressCallback:t}):this.createTextModel(s,{dtype:a,device:n,use_external_data_format:o,progressCallback:t});return this.instances.set(e,d),d}static async createTextModel(e,t){let[r,i]=await Promise.all([Z.AutoTokenizer.from_pretrained(e,{progress_callback:t.progressCallback,legacy:!0}),Z.AutoModelForCausalLM.from_pretrained(e,{dtype:t.dtype,device:t.device,use_external_data_format:t.use_external_data_format,progress_callback:t.progressCallback})]);return[r,i]}static async createVisionModel(e,t){let[r,i]=await Promise.all([Z.AutoProcessor.from_pretrained(e,{progress_callback:t.progressCallback}),Z.AutoModelForVision2Seq.from_pretrained(e,{dtype:t.dtype||"fp32",device:t.device||"webgpu",use_external_data_format:t.use_external_data_format,progress_callback:t.progressCallback})]);return[r,i]}static clearCache(){this.instances.clear()}};ee.configs=new Map,ee.instances=new Map;var et=class{constructor(){this.stopping_criteria=new Z.InterruptableStoppingCriteria,this.isVisionModel=!1,this.currentModelKey="default"}async generate(e,t){try{let r=await ee.getInstance(this.currentModelKey);await this.runGeneration(r,e,t)}catch(e){this.sendError(e instanceof Error?e.message:String(e))}}async runGeneration(e,t,r){var i;let s,a;let[n,o]=e,l=this.isVisionModel;if(l){let e=t.slice(-1),r=await Promise.all(e.map(e=>e.content).flat(1/0).filter(e=>void 0!==e.image).map(e=>(0,Z.load_image)(e.image))),i=n.apply_chat_template(e,{add_generation_prompt:!0});s=await n(i,r)}else s=n.apply_chat_template(t,{add_generation_prompt:!0,return_dict:!0});let d=0,c=new Z.TextStreamer(l?n.tokenizer:n,{skip_prompt:!0,skip_special_tokens:!0,callback_function:e=>{let t=a?d/(performance.now()-a)*1e3:void 0;this.sendUpdate(e,t,d)},token_callback_function:()=>{a??(a=performance.now()),d++}}),p=new Z.StoppingCriteriaList;p.push(this.stopping_criteria);let u={...l?{do_sample:!1,repetition_penalty:1.1,max_new_tokens:1024}:{do_sample:!0,top_k:3,temperature:.7,max_new_tokens:512},...r,streamer:c,stopping_criteria:p,return_dict_in_generate:!0};this.sendMessage({status:"start"});let g=Object.assign({},s,u),h=await o.generate(g),f=h.sequences||h,m=(i=l?0:s.input_ids.data.length,l?n.batch_decode(f,{skip_special_tokens:!0}):(Array.isArray(f)?f:[f]).map(e=>{let t=e.data||e,r=Array.isArray(t)?t:Array.from(t),s=r.length>i?r.slice(i):r;return s.length>0?n.decode(s,{skip_special_tokens:!0}):""}));self.postMessage({status:"complete",output:m})}async load(e){try{ee.clearCache(),this.isVisionModel=e?.isVisionModel||!1;let t=e?.modelId||(this.isVisionModel?"HuggingFaceTB/SmolVLM-256M-Instruct":"HuggingFaceTB/SmolLM2-360M-Instruct");ee.configure(this.currentModelKey,{...e,modelId:t}),this.sendMessage({status:"loading",data:"Loading model..."});let r=this.createThrottledProgressCallback(),i=await ee.getInstance(this.currentModelKey,r);if(this.isVisionModel)this.sendMessage({status:"loading",data:"Model loaded and ready..."});else{this.sendMessage({status:"loading",data:"Compiling shaders and warming up model..."});let[e,t]=i,r=e("a");await t.generate({...r,max_new_tokens:1})}this.sendMessage({status:"ready"})}catch(e){console.error("Error in worker load:",e),this.sendError(e instanceof Error?e.message:String(e))}}interrupt(){this.stopping_criteria.interrupt()}reset(){this.stopping_criteria.reset(),ee.clearCache()}sendMessage(e){self.postMessage(e)}sendUpdate(e,t,r){self.postMessage({status:"update",output:e,tps:t,numTokens:r})}sendError(e){self.postMessage({status:"error",data:e})}createThrottledProgressCallback(){let e=0;return t=>{let r=performance?.now?.()??Date.now();if("progress"===t.status){if(r-e<100)return;e=r}self.postMessage(t)}}onmessage(e){try{let{type:t,data:r}=e.data||{};switch(t){case"load":this.load(r);break;case"generate":this.stopping_criteria.reset(),this.generate(r,e.data.generationOptions);break;case"interrupt":this.interrupt();break;case"reset":this.reset();break;default:this.sendError(`Unknown message type: ${t}`)}}catch(e){this.sendError(e instanceof Error?e.message:String(e))}}},er=r(98529),ei=class{static configure(e,t){this.configs.set(e,t)}static async getInstance(e,t){let r=this.instances.get(e);if(r)return r;let i=this.configs.get(e);if(!i||!i.modelId)throw Error(`No configuration found for key: ${e}`);let{modelId:s,dtype:a="auto",device:n="auto"}=i,o=this.createTranscriptionModel(s,{dtype:a,device:n,progressCallback:t});return this.instances.set(e,o),o}static async createTranscriptionModel(e,t){let[r,i,s]=await Promise.all([er.AutoTokenizer.from_pretrained(e,{progress_callback:t.progressCallback}),er.AutoProcessor.from_pretrained(e,{progress_callback:t.progressCallback}),er.WhisperForConditionalGeneration.from_pretrained(e,{dtype:t.dtype||{encoder_model:"fp32",decoder_model_merged:"q4"},device:t.device||"auto",progress_callback:t.progressCallback})]);return[r,i,s]}static clearCache(){this.instances.clear()}};ei.configs=new Map,ei.instances=new Map;var es=class{constructor(){this.processing=!1,this.currentModelKey="default"}async generate({audio:e,language:t,maxNewTokens:r}){if(!this.processing){this.processing=!0;try{let i,s;this.sendMessage({status:"start"});let[a,n,o]=await ei.getInstance(this.currentModelKey),l=0,d=new er.TextStreamer(a,{skip_prompt:!0,skip_special_tokens:!0,callback_function:e=>{let t=i?l/(performance.now()-i)*1e3:void 0;this.sendUpdate(e,t,l)},token_callback_function:()=>{i??(i=performance.now()),l++>0&&performance.now()}});s=Array.isArray(e)?new Float32Array(e):e instanceof Float32Array?e:new Float32Array(e);let c=await n(s),p=await o.generate({...c,max_new_tokens:r||448,language:t,streamer:d}),u=a.batch_decode(p,{skip_special_tokens:!0});this.sendMessage({status:"complete",output:u})}catch(e){this.sendError(e instanceof Error?e.message:String(e))}finally{this.processing=!1}}}async load(e){try{ei.clearCache();let t=e?.modelId;ei.configure(this.currentModelKey,{...e,modelId:t}),this.sendMessage({status:"loading",data:"Loading model..."});let r=this.createThrottledProgressCallback(),[i,s,a]=await ei.getInstance(this.currentModelKey,r);this.sendMessage({status:"loading",data:"Compiling shaders and warming up model..."});try{await a.generate({inputs:(0,er.full)([1,80,3e3],0),max_new_tokens:1})}catch(e){console.warn("Model warmup failed:",e)}this.sendMessage({status:"ready"})}catch(e){console.error("Error in transcription worker load:",e),this.sendError(e instanceof Error?e.message:String(e))}}interrupt(){this.processing=!1}reset(){this.processing=!1,ei.clearCache()}sendMessage(e){self.postMessage(e)}sendUpdate(e,t,r){self.postMessage({status:"update",output:e,tps:t,numTokens:r})}sendError(e){self.postMessage({status:"error",data:e})}createThrottledProgressCallback(){let e=0;return t=>{let r=performance?.now?.()??Date.now();if("progress"===t.status){if(r-e<100)return;e=r}self.postMessage(t)}}onmessage(e){try{let{type:t,data:r}=e.data||{};switch(t){case"load":this.load(r);break;case"generate":this.generate(r);break;case"interrupt":this.interrupt();break;case"reset":this.reset();break;default:this.sendError(`Unknown message type: ${t}`)}}catch(e){this.sendError(e instanceof Error?e.message:String(e))}}}}}]);